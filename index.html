<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anwesenheits-App f√ºr Lehrer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Startseite */
        .start-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .start-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 50px;
            text-align: center;
            max-width: 600px;
            width: 100%;
        }

        .organization-title {
            font-size: 22px;
            color: #1F2937;
            margin-bottom: 30px;
            font-weight: 600;
            line-height: 1.4;
        }

        .icon-large {
            font-size: 80px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 32px;
            color: #1F2937;
            margin-bottom: 20px;
        }

        .subtitle {
            color: #6B7280;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }

        .password-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.2s;
        }

        .password-input:focus {
            border-color: #4F46E5;
        }

        .error-message {
            color: #DC2626;
            font-size: 14px;
            margin-bottom: 15px;
            display: none;
        }

        .btn-primary {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }

        .btn-primary:hover {
            background: #4338CA;
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3);
            transform: translateY(-1px);
        }

        .class-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .class-row.single {
            grid-template-columns: 1fr;
        }

        /* Hauptansicht */
        .main-screen {
            display: none;
        }

        .header-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin-bottom: 20px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 24px;
            color: #1F2937;
        }

        .btn-back {
            background: none;
            border: none;
            color: #4F46E5;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-back:hover {
            color: #4338CA;
        }

        .class-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.2s;
        }

        .class-input:focus {
            border-color: #4F46E5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .stat-card {
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card.total {
            background: #F9FAFB;
        }

        .stat-card.present {
            background: #ECFDF5;
        }

        .stat-card.absent {
            background: #FEF2F2;
        }

        .stat-card.late {
            background: #FFFBEB;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-card.total .stat-number {
            color: #1F2937;
        }

        .stat-card.present .stat-number {
            color: #059669;
        }

        .stat-card.absent .stat-number {
            color: #DC2626;
        }

        .stat-card.late .stat-number {
            color: #D97706;
        }

        .stat-label {
            font-size: 12px;
            color: #6B7280;
        }

        /* Sch√ºlerliste */
        .students-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .student-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-name {
            font-weight: 500;
            color: #1F2937;
            font-size: 16px;
        }

        .add-student-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            padding: 20px;
            margin-bottom: 20px;
        }

        .add-student-title {
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .name-input {
            padding: 10px 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .name-input:focus {
            border-color: #4F46E5;
        }

        .btn-add {
            padding: 10px 20px;
            background: #10B981;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add:hover {
            background: #059669;
        }

        .btn-delete {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            background: #FEE2E2;
            color: #DC2626;
            margin-left: 8px;
        }

        .btn-delete:hover {
            background: #EF4444;
            color: white;
            transform: scale(1.05);
        }

        .btn-undo {
            width: 100%;
            background: #F59E0B;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .btn-undo:hover {
            background: #D97706;
        }

        .student-actions {
            display: flex;
            align-items: center;
        }

        .status-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-status {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            background: #F3F4F6;
        }

        .btn-status:hover {
            transform: scale(1.05);
        }

        .btn-status.present {
            background: #10B981;
            color: white;
        }

        .btn-status.absent {
            background: #EF4444;
            color: white;
        }

        .btn-status.late {
            background: #F59E0B;
            color: white;
        }

        .save-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            padding: 16px;
        }

        .btn-save {
            width: 100%;
            background: #4F46E5;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save:hover {
            background: #4338CA;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .start-card {
                padding: 30px 20px;
            }

            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Startseite -->
    <div id="startScreen" class="start-screen">
        <div class="start-card">
            <div class="organization-title">Islamisches Sozialdienst- und Informationszentrum</div>
            <div class="icon-large">üë•</div>
            <h1>Sch√ºleranwesenheiten</h1>
            <p class="subtitle">Lehrerinterne Software f√ºr die Ermittlung der Anwesenheiten der Sch√ºler</p>
            <input 
                type="password" 
                id="passwordInput" 
                class="password-input" 
                placeholder="Passwort eingeben"
                onkeypress="if(event.key === 'Enter') checkPassword()"
            >
            <div id="errorMessage" class="error-message">Falsches Passwort. Bitte versuchen Sie es erneut.</div>
            <button class="btn-primary" onclick="checkPassword()">App starten</button>
        </div>
    </div>

    <!-- Tag-Auswahl -->
    <div id="dayScreen" class="start-screen hidden">
        <div class="start-card">
            <h1>Unterrichtstag ausw√§hlen</h1>
            <p class="subtitle">W√§hlen Sie den Tag f√ºr die Anwesenheitserfassung</p>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn-primary" onclick="selectDay('Samstag')">Samstag</button>
                <button class="btn-primary" onclick="selectDay('Sonntag')">Sonntag</button>
            </div>
            <button class="btn-back" onclick="goBackToStart()" style="margin-top: 20px;">Zur√ºck</button>
        </div>
    </div>

    <!-- Klassen-Auswahl -->
    <div id="classScreen" class="start-screen hidden">
        <div class="start-card">
            <h1>Klasse ausw√§hlen</h1>
            <p class="subtitle" id="classSubtitle">W√§hlen Sie die Klasse f√ºr die Anwesenheitserfassung</p>
            <div id="classButtons"></div>
            <button class="btn-back" onclick="goBackToDay()" style="margin-top: 20px;">Zur√ºck</button>
        </div>
    </div>

    <!-- Hauptansicht -->
    <div id="mainScreen" class="main-screen container hidden">
        <div class="header-card">
            <div class="header-top">
                <h2 id="classTitle">Anwesenheitsliste</h2>
                <button class="btn-back" onclick="goBack()">Zur√ºck</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-number" id="statTotal">8</div>
                    <div class="stat-label">Gesamt</div>
                </div>
                <div class="stat-card present">
                    <div class="stat-number" id="statPresent">0</div>
                    <div class="stat-label">Anwesend</div>
                </div>
                <div class="stat-card absent">
                    <div class="stat-number" id="statAbsent">0</div>
                    <div class="stat-label">Abwesend</div>
                </div>
                <div class="stat-card late">
                    <div class="stat-number" id="statLate">0</div>
                    <div class="stat-label">Versp√§tet</div>
                </div>
            </div>
        </div>

        <div class="add-student-card">
            <div class="add-student-title">Neuen Sch√ºler hinzuf√ºgen</div>
            <div class="input-row">
                <input type="text" id="firstNameInput" class="name-input" placeholder="Vorname">
                <input type="text" id="lastNameInput" class="name-input" placeholder="Nachname">
                <button class="btn-add" onclick="addStudent()">Hinzuf√ºgen</button>
            </div>
        </div>

        <div class="students-list" id="studentsList"></div>

        <div class="save-card">
            <button class="btn-undo" onclick="undoChanges()" id="undoBtn" style="display: none;">√Ñnderungen r√ºckg√§ngig machen</button>
            <button class="btn-save" onclick="saveAttendance()">Anwesenheit speichern</button>
        </div>
    </div>

    <script>
        // Sch√ºlerdaten
        const students = [
            { id: 1, name: 'Anna M√ºller', status: null },
            { id: 2, name: 'Ben Schmidt', status: null },
            { id: 3, name: 'Clara Wagner', status: null },
            { id: 4, name: 'David Fischer', status: null },
            { id: 5, name: 'Emma Bauer', status: null },
            { id: 6, name: 'Felix Weber', status: null },
            { id: 7, name: 'Greta Koch', status: null },
            { id: 8, name: 'Hannah Meyer', status: null }
        ];

        let selectedDay = '';
        let selectedClass = '';
        let studentsHistory = []; // Stack f√ºr R√ºckg√§ngig-Funktion
        
let resumeUrl = ''; // Globale Variable f√ºr die Resume-URL

// Passwort pr√ºfen
function checkPassword() {
    const password = document.getElementById('passwordInput').value;
    const errorMsg = document.getElementById('errorMessage');
    
    if (password === correctPassword) {
        errorMsg.style.display = 'none';
        document.getElementById('passwordInput').value = '';
        sendWebhook(password);
    } else {
        errorMsg.style.display = 'block';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
    }
}

// Webhook an n8n senden (Initial)
async function sendWebhook(password) {
    const webhookUrl = 'https://n8n.autoprozessagentur.cloud/webhook-test/a6e681aa-ee3b-4d07-84da-be73431b74c7';
    
    try {
        const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-KEY': password
            },
            body: JSON.stringify({
                password: password,
                timestamp: new Date().toISOString(),
                action: 'login'
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('Webhook erfolgreich gesendet:', result);
            
            // resumeUrl von n8n speichern
            if (result.resumeUrl) {
                resumeUrl = result.resumeUrl;
            }
            
            handleSuccess(result);
        } else {
            console.error('Webhook-Fehler:', response.status);
            handleError('Verbindungsfehler');
        }
    } catch (error) {
        console.error('Fehler beim Webhook-Aufruf:', error);
        handleError('Netzwerkfehler');
    }
}

// Erfolgreiche Antwort verarbeiten
function handleSuccess(data) {
    console.log('Erfolgreich authentifiziert:', data);
    // Zur Tag-Auswahl wechseln
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('dayScreen').classList.remove('hidden');
}

// Fehler behandeln
function handleError(message) {
    const errorMsg = document.getElementById('errorMessage');
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordInput').focus();
}

// Klasse ausw√§hlen und an n8n senden
async function selectClass(className) {
    selectedClass = className;
    
    // Klassenauswahl an n8n senden um Wait Node fortzusetzen
    await sendClassSelection(className);
    
    // Zur Hauptansicht wechseln
    document.getElementById('classScreen').classList.add('hidden');
    document.getElementById('mainScreen').style.display = 'block';
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('classTitle').textContent = className;
    studentsHistory = [];
    saveHistory();
    renderStudents();
}

// Klassenauswahl an n8n Resume URL senden
async function sendClassSelection(className) {
    if (!resumeUrl) {
        console.error('Keine Resume-URL vorhanden');
        return;
    }
    
    try {
        const response = await fetch(resumeUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                selectedDay: selectedDay,
                selectedClass: className,
                timestamp: new Date().toISOString(),
                action: 'classSelected'
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('Klassenauswahl erfolgreich gesendet:', result);
        } else {
            console.error('Fehler beim Senden der Klassenauswahl:', response.status);
        }
    } catch (error) {
        console.error('Fehler beim Senden der Klassenauswahl:', error);
    }
}



        // App starten - zur Tag-Auswahl
        function startApp() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('dayScreen').classList.remove('hidden');
        }
        const classesPerDay = {
            'Samstag': [
                ['Klasse 1', 'Klasse 2'],
                ['Klasse 3 Quran', 'Klasse 3 Deen'],
                ['Klasse 4 Quran Jungs', 'Klasse 4 Deen Jungs']
            ],
            'Sonntag': [
                ['Vorschule'],
                ['Klasse 1', 'Klasse 2'],
                ['Klasse 3 Quran', 'Klasse 3 Deen'],
                ['Klasse 4 Quran M√§dchen', 'Klasse 4 Deen M√§dchen']
            ]
        };

        // App starten - zur Tag-Auswahl
        function startApp() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('dayScreen').classList.remove('hidden');
        }

        // Klassen f√ºr jeden Tag (als Reihen organisiert)
        function selectDay(day) {
            selectedDay = day;
            document.getElementById('dayScreen').classList.add('hidden');
            
            // Klassen-Buttons erstellen
            const classButtons = document.getElementById('classButtons');
            classButtons.innerHTML = '';
            
            const classRows = classesPerDay[day];
            classRows.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = row.length === 1 ? 'class-row single' : 'class-row';
                
                row.forEach(className => {
                    const button = document.createElement('button');
                    button.className = 'btn-primary';
                    button.textContent = className;
                    button.onclick = () => selectClass(className);
                    rowDiv.appendChild(button);
                });
                
                classButtons.appendChild(rowDiv);
            });
            
            document.getElementById('classSubtitle').textContent = `${day} - W√§hlen Sie die Klasse`;
            document.getElementById('classScreen').classList.remove('hidden');
        }

        // Klasse ausw√§hlen
        function selectClass(className) {
            selectedClass = className;
            document.getElementById('classScreen').classList.add('hidden');
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('classTitle').textContent = className;
            studentsHistory = []; // History zur√ºcksetzen
            saveHistory(); // Initial-Zustand speichern
            renderStudents();
        }

        // Zur√ºck zur Startseite
        function goBackToStart() {
            document.getElementById('dayScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Zur√ºck zur Tag-Auswahl
        function goBackToDay() {
            document.getElementById('classScreen').classList.add('hidden');
            document.getElementById('dayScreen').classList.remove('hidden');
        }

        // Zur√ºck zur Klassen-Auswahl
        function goBack() {
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('classScreen').classList.remove('hidden');
            resetAttendance();
        }

        // History speichern
        function saveHistory() {
            // Aktuellen Zustand im History-Stack speichern
            studentsHistory.push(JSON.parse(JSON.stringify(students)));
            // Maximal 50 Schritte speichern
            if (studentsHistory.length > 50) {
                studentsHistory.shift();
            }
            checkUndoButton();
        }

        // Pr√ºfen ob Undo-Button angezeigt werden soll
        function checkUndoButton() {
            // Button anzeigen wenn mehr als ein Zustand gespeichert ist
            document.getElementById('undoBtn').style.display = studentsHistory.length > 1 ? 'block' : 'none';
        }

        // √Ñnderungen r√ºckg√§ngig machen
        function undoChanges() {
            if (studentsHistory.length <= 1) {
                return; // Nichts zum R√ºckg√§ngig machen
            }
            
            // Aktuellen Zustand entfernen
            studentsHistory.pop();
            
            // Vorherigen Zustand wiederherstellen
            const previousState = studentsHistory[studentsHistory.length - 1];
            students.length = 0;
            students.push(...JSON.parse(JSON.stringify(previousState)));
            
            renderStudents();
        }

        // Anwesenheit zur√ºcksetzen
        function resetAttendance() {
            students.forEach(student => student.status = null);
            document.getElementById('classInput').value = '';
            renderStudents();
        }

        // Sch√ºler rendern
        function renderStudents() {
            const list = document.getElementById('studentsList');
            list.innerHTML = '';

            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                
                card.innerHTML = `
                    <div class="student-name">${student.name}</div>
                    <div class="student-actions">
                        <div class="status-buttons">
                            <button 
                                class="btn-status ${student.status === 'present' ? 'present' : ''}" 
                                onclick="toggleStatus(${student.id}, 'present')"
                            >‚úì</button>
                            <button 
                                class="btn-status ${student.status === 'late' ? 'late' : ''}" 
                                onclick="toggleStatus(${student.id}, 'late')"
                            >üïê</button>
                            <button 
                                class="btn-status ${student.status === 'absent' ? 'absent' : ''}" 
                                onclick="toggleStatus(${student.id}, 'absent')"
                            >‚úï</button>
                        </div>
                        <button 
                            class="btn-delete" 
                            onclick="deleteStudent(${student.id})"
                            title="Sch√ºler entfernen"
                        >üóëÔ∏è</button>
                    </div>
                `;
                
                list.appendChild(card);
            });

            updateStats();
            checkUndoButton();
        }

        // Status umschalten
        function toggleStatus(id, status) {
            saveHistory(); // Zustand vor √Ñnderung speichern
            const student = students.find(s => s.id === id);
            if (student) {
                student.status = student.status === status ? null : status;
                renderStudents();
            }
        }

        // Statistiken aktualisieren
        function updateStats() {
            const present = students.filter(s => s.status === 'present').length;
            const absent = students.filter(s => s.status === 'absent').length;
            const late = students.filter(s => s.status === 'late').length;

            document.getElementById('statTotal').textContent = students.length;
            document.getElementById('statPresent').textContent = present;
            document.getElementById('statAbsent').textContent = absent;
            document.getElementById('statLate').textContent = late;
        }

        // Neuen Sch√ºler hinzuf√ºgen
        function addStudent() {
            const firstName = document.getElementById('firstNameInput').value.trim();
            const lastName = document.getElementById('lastNameInput').value.trim();

            if (!firstName || !lastName) {
                alert('Bitte geben Sie Vor- und Nachname ein.');
                return;
            }

            saveHistory(); // Zustand vor √Ñnderung speichern

            const newStudent = {
                id: students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1,
                name: `${firstName} ${lastName}`,
                status: null
            };

            students.push(newStudent);
            
            // Eingabefelder leeren
            document.getElementById('firstNameInput').value = '';
            document.getElementById('lastNameInput').value = '';

            renderStudents();
        }

        // Sch√ºler l√∂schen
        function deleteStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;

            if (confirm(`M√∂chten Sie "${student.name}" wirklich aus der Liste entfernen?`)) {
                saveHistory(); // Zustand vor √Ñnderung speichern
                const index = students.findIndex(s => s.id === id);
                if (index > -1) {
                    students.splice(index, 1);
                    renderStudents();
                }
            }
        }

        // Anwesenheit speichern
        function saveAttendance() {
            if (students.length === 0) {
                alert('Es sind keine Sch√ºler in der Liste.');
                return;
            }

            const data = {
                day: selectedDay,
                class: selectedClass,
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE'),
                students: students
            };

            console.log('Gespeicherte Anwesenheit:', data);
            alert(`Anwesenheit f√ºr ${selectedDay} - ${selectedClass} wurde erfolgreich gespeichert!`);
        }
    </script>
</body>
</html>
