<script>
    // ============================================
    // Globale Variablen und Konfiguration
    // ============================================
    const correctPassword = '123';
    const webhookUrl = 'https://n8n.autoprozessagentur.cloud/webhook-test/a6e681aa-ee3b-4d07-84da-be73431b74c7';
    
    let selectedDay = '';
    let selectedClass = '';
    let resumeUrl = '';
    let studentsHistory = [];
    let students = []; // âœ… Jetzt leer - wird von n8n gefÃ¼llt

    const classesPerDay = {
        'Samstag': [
            ['Klasse 1', 'Klasse 2'],
            ['Klasse 3 Quran', 'Klasse 3 Deen'],
            ['Klasse 4 Quran Jungs', 'Klasse 4 Deen Jungs']
        ],
        'Sonntag': [
            ['Vorschule'],
            ['Klasse 1', 'Klasse 2'],
            ['Klasse 3 Quran', 'Klasse 3 Deen'],
            ['Klasse 4 Quran MÃ¤dchen', 'Klasse 4 Deen MÃ¤dchen']
        ]
    };

    // ============================================
    // Authentifizierung & Webhook
    // ============================================
    function checkPassword() {
        const password = document.getElementById('passwordInput').value;
        const errorMsg = document.getElementById('errorMessage');
        
        if (password === correctPassword) {
            errorMsg.style.display = 'none';
            document.getElementById('passwordInput').value = '';
            sendWebhook(password);
        } else {
            errorMsg.style.display = 'block';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }
    }

    async function sendWebhook(password) {
        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': password
                },
                body: JSON.stringify({
                    password: password,
                    timestamp: new Date().toISOString(),
                    action: 'login'
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('Webhook erfolgreich gesendet:', result);
                
                if (result.resumeUrl) {
                    resumeUrl = result.resumeUrl;
                }
                
                handleSuccess();
            } else {
                console.error('Webhook-Fehler:', response.status);
                handleError('Verbindungsfehler');
            }
        } catch (error) {
            console.error('Fehler beim Webhook-Aufruf:', error);
            handleError('Netzwerkfehler');
        }
    }

    function handleSuccess() {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('dayScreen').classList.remove('hidden');
    }

    function handleError(message) {
        const errorMsg = document.getElementById('errorMessage');
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
    }

    // ============================================
    // Navigation zwischen Screens
    // ============================================
    function selectDay(day) {
        selectedDay = day;
        document.getElementById('dayScreen').classList.add('hidden');
        
        const classButtons = document.getElementById('classButtons');
        classButtons.innerHTML = '';
        
        const classRows = classesPerDay[day];
        classRows.forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.className = row.length === 1 ? 'class-row single' : 'class-row';
            
            row.forEach(className => {
                const button = document.createElement('button');
                button.className = 'btn-primary';
                button.textContent = className;
                button.onclick = () => selectClass(className);
                rowDiv.appendChild(button);
            });
            
            classButtons.appendChild(rowDiv);
        });
        
        document.getElementById('classSubtitle').textContent = `${day} - WÃ¤hlen Sie die Klasse`;
        document.getElementById('classScreen').classList.remove('hidden');
    }

    // âœ… NEUE FUNKTION: SchÃ¼lerdaten von n8n empfangen
    async function selectClass(className) {
        selectedClass = className;
        
        // Ladeanimation anzeigen
        document.getElementById('classScreen').classList.add('hidden');
        document.getElementById('mainScreen').style.display = 'block';
        document.getElementById('mainScreen').classList.remove('hidden');
        document.getElementById('classTitle').textContent = className + ' - Laden...';
        
        if (resumeUrl) {
            try {
                // Klassendaten an n8n senden
                const response = await fetch(resumeUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        day: selectedDay,
                        class: selectedClass,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Response von n8n:', result);
                    
                    // âœ… SchÃ¼lerdaten von n8n empfangen
                    if (result.students && Array.isArray(result.students)) {
                        students = result.students.map((student, index) => ({
                            id: student.id || index + 1,
                            name: student.name,
                            status: null
                        }));
                    }
                    
                    // Titel aktualisieren
                    document.getElementById('classTitle').textContent = className;
                    studentsHistory = [];
                    saveHistory();
                    renderStudents();
                    
                } else {
                    console.error('Fehler beim Laden der SchÃ¼ler:', response.status);
                    alert('Fehler beim Laden der SchÃ¼lerliste');
                }
                
            } catch (error) {
                console.error('Fehler:', error);
                alert('Netzwerkfehler beim Laden der SchÃ¼lerliste');
            }
        }
    }

    function goBackToStart() {
        document.getElementById('dayScreen').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
        document.getElementById('errorMessage').style.display = 'none';
    }

    function goBackToDay() {
        document.getElementById('classScreen').classList.add('hidden');
        document.getElementById('dayScreen').classList.remove('hidden');
    }

    function goBack() {
        document.getElementById('mainScreen').classList.add('hidden');
        document.getElementById('classScreen').classList.remove('hidden');
        resetAttendance();
    }

    // ============================================
    // SchÃ¼ler-Verwaltung
    // ============================================
    function renderStudents() {
        const list = document.getElementById('studentsList');
        list.innerHTML = '';

        students.forEach(student => {
            const card = document.createElement('div');
            card.className = 'student-card';
            
            card.innerHTML = `
                <div class="student-name">${student.name}</div>
                <div class="student-actions">
                    <div class="status-buttons">
                        <button 
                            class="btn-status ${student.status === 'present' ? 'present' : ''}" 
                            onclick="toggleStatus(${student.id}, 'present')"
                        >âœ“</button>
                        <button 
                            class="btn-status ${student.status === 'late' ? 'late' : ''}" 
                            onclick="toggleStatus(${student.id}, 'late')"
                        >ğŸ•</button>
                        <button 
                            class="btn-status ${student.status === 'absent' ? 'absent' : ''}" 
                            onclick="toggleStatus(${student.id}, 'absent')"
                        >âœ•</button>
                    </div>
                    <button 
                        class="btn-delete" 
                        onclick="deleteStudent(${student.id})"
                        title="SchÃ¼ler entfernen"
                    >ğŸ—‘ï¸</button>
                </div>
            `;
            
            list.appendChild(card);
        });

        updateStats();
        checkUndoButton();
    }

    function addStudent() {
        const firstName = document.getElementById('firstNameInput').value.trim();
        const lastName = document.getElementById('lastNameInput').value.trim();

        if (!firstName || !lastName) {
            alert('Bitte geben Sie Vor- und Nachname ein.');
            return;
        }

        saveHistory();

        const newStudent = {
            id: students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1,
            name: `${firstName} ${lastName}`,
            status: null
        };

        students.push(newStudent);
        
        document.getElementById('firstNameInput').value = '';
        document.getElementById('lastNameInput').value = '';

        renderStudents();
    }

    function deleteStudent(id) {
        const student = students.find(s => s.id === id);
        if (!student) return;

        if (confirm(`MÃ¶chten Sie "${student.name}" wirklich aus der Liste entfernen?`)) {
            saveHistory();
            const index = students.findIndex(s => s.id === id);
            if (index > -1) {
                students.splice(index, 1);
                renderStudents();
            }
        }
    }

    function toggleStatus(id, status) {
        saveHistory();
        const student = students.find(s => s.id === id);
        if (student) {
            student.status = student.status === status ? null : status;
            renderStudents();
        }
    }

    // ============================================
    // Statistiken & Status
    // ============================================
    function updateStats() {
        const present = students.filter(s => s.status === 'present').length;
        const absent = students.filter(s => s.status === 'absent').length;
        const late = students.filter(s => s.status === 'late').length;

        document.getElementById('statTotal').textContent = students.length;
        document.getElementById('statPresent').textContent = present;
        document.getElementById('statAbsent').textContent = absent;
        document.getElementById('statLate').textContent = late;
    }

    function resetAttendance() {
        students.forEach(student => student.status = null);
        renderStudents();
    }

    // ============================================
    // History & Undo-FunktionalitÃ¤t
    // ============================================
    function saveHistory() {
        studentsHistory.push(JSON.parse(JSON.stringify(students)));
        if (studentsHistory.length > 50) {
            studentsHistory.shift();
        }
        checkUndoButton();
    }

    function checkUndoButton() {
        document.getElementById('undoBtn').style.display = studentsHistory.length > 1 ? 'block' : 'none';
    }

    function undoChanges() {
        if (studentsHistory.length <= 1) return;
        
        studentsHistory.pop();
        const previousState = studentsHistory[studentsHistory.length - 1];
        students.length = 0;
        students.push(...JSON.parse(JSON.stringify(previousState)));
        
        renderStudents();
    }

    // ============================================
    // Speichern & Export
    // ============================================
    function saveAttendance() {
        if (students.length === 0) {
            alert('Es sind keine SchÃ¼ler in der Liste.');
            return;
        }

        const data = {
            day: selectedDay,
            class: selectedClass,
            date: new Date().toLocaleDateString('de-DE'),
            time: new Date().toLocaleTimeString('de-DE'),
            students: students
        };

        console.log('Gespeicherte Anwesenheit:', data);
        alert(`Anwesenheit fÃ¼r ${selectedDay} - ${selectedClass} wurde erfolgreich gespeichert!`);
    }
</script>
